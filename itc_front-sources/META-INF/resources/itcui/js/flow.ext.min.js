window._agentIE||function(a){a.fn.extend({ITCUI_FileUpload:function(b,c){var d=a(this),e=this,f='<div class="itc_upload_wrap bbox ${preview}" fileid="${fileID}" unique-id="${uniqueID}"><div class="itc_upload_icon icon_${fileExt} ml8"></div><div class="itc_upload_detail_wrap ml4"><div class="itc_upload_filename"><span class="itc_filename" title="${fileName}">${fileName}</span></div><div style="clear:both" class="itc_upload_progress_line"><div class="itc_upload_progress_txt" style="margin-left:-4px"><span class="fl">${fileSize}</span><a class="itc_upload_cancel itc_link fr">取消</a><a class="itc_upload_delfail itc_link_del itc_link fr" style="display:none" reserved="${reserved}" creator="${creator}">删除</a><a class="itc_upload_top itc_link fr" style="margin-right:6px">置顶</a><a class="itc_upload_down itc_link fr" style="display:none;margin-right:6px">下载</a></div></div></div> </div>',g='<div class="itc_upload_progess_wrap"><div class="itc_upload_progress_bar" style="width:0px"></div></div>';if(e.parseFileItem=function(a){var b={fileExt:_itc_getextname(a.name),fileSize:_itc_getfilesize(a.size),fileName:a.name,creator:a.creator||"",reserved:a.reserved||!1,fileID:a.fileID||-1,uniqueID:a.uniqueIdentifier,preview:""};return e.applyTemplate(f,b)},e.applyTemplate=function(a,b){var c,d;for(c in b)d=b[c],re=new RegExp("\\$\\{"+c+"\\}","g"),a=a.replace(re,d);return a},e.cancelFile=function(a,b){var c=b.parents(".itc_upload_wrap"),d=c.attr("unique-id"),e=a.getFromUniqueIdentifier(d);e&&(e.cancel(),c.remove())},e.delUploadedFile=function(b){var g,c=b.parents(".itc_upload_wrap"),d=c.parent(),e=c.attr("fileid"),f=c.data("ajaxMsg")||e;f&&(g=d.data("options"),g&&(g.delFileAfterPost&&c.attr("init")?(c.remove(),g.singleFile):Notice.confirm("确认删除|是否删除该文件？该操作无法恢复。",function(){var b=d.data("flow").files,e=c.attr("unique-id"),h={type:"GET",dataType:"json",error:function(){FW.error("文件删除失败")},success:function(a){var d,f;if(a&&1!=a.status)FW.error(a.msg||"文件删除失败");else{for(FW.success("文件删除成功"),d=0;d<b.length;d++)if(f=b[d],f.uniqueIdentifier==e){b.splice(d,1);break}c.remove(),g.singleFile}}};g.delFileUrl?(h.url=g.delFileUrl,h.data={id:f}):h.url=f,a.ajax(h)})))},e.init=function(){var c,h,i,j,k,l,m,n;d.attr("id")&&(b||"object"==typeof b)&&(c=d.attr("id")+"_real",h=d.attr("id")+"_queue",a("#"+c).data("isUploadFinish",!0),a("<div></div>").appendTo(d).attr("id",c),a("<div></div>").appendTo(d).attr("id",h).css({width:"100%",clear:"both"}).addClass("upload-queue"),i=b.buttonText||"添加附件",j=b.buttonClass||"itc_link_add",b.itemTemplate=b.itemTemplate||f,k=c+"-button",l="<div id='"+k+"' class='uploadify-button "+j+"' style='height: 20px; line-height: 16px; width: 72px;'>"+"<span class='uploadify-button-text' style='text-decoration: none;'>"+i+"</span>"+"</div>",a("#"+c).addClass("uploadify").css({height:"20px",width:"72px","float":"left"}).html(l),m=a("#"+h),m.data("options",b),n=new Flow({target:b.uploader,chunkSize:104857600,testChunks:!1,allowDuplicateUploads:!0}),m.data("flow",n),m.on("click",function(b){var d,f,c=a(b.target);c.hasClass("itc_link_del")?c.hasClass("itc_upload_delfail")||e.delUploadedFile(c):c.hasClass("itc_upload_cancel")?e.cancelFile(n,c):c.hasClass("itc_upload_top")&&(d=c.parents(".itc_upload_wrap"),f=d.parents(".upload-queue"),d.detach().prependTo(f))}),n.on("filesAdded",function(){setTimeout(function(){n.upload()},200)}),n.on("fileAdded",function(c){var f,i;return b.fileSizeLimit&&c.size/1e3>b.fileSizeLimit?(f=c.name+"过大",FW.error(f),!1):(a("#"+h).append(e.parseFileItem(c)),m.children("[unique-id='"+c.uniqueIdentifier+"']").find(".itc_upload_progress_txt").prepend(g),i=setInterval(function(){var b=c,d=i,e=h,f=0==b.size?46:parseInt(46*(b.sizeUploaded()/b.size));a("#"+e).children("[unique-id='"+b.uniqueIdentifier+"']").find(".itc_upload_progress_bar").css("width",f+"px"),c.isComplete()&&(console.log("file upload finish"),clearTimeout(d))},200),void 0)}),n.on("fileProgress",function(){}),n.on("fileError",function(a){var c=m.children("[unique-id='"+a.uniqueIdentifier+"']");c.find(".itc_upload_progess_wrap").remove(),c.find(".itc_upload_progress_txt").append('<span class="itc_upload_fail">上传失败</span>')}),n.on("fileSuccess",function(c,d){var g,h,i,f=m.children(".itc_upload_wrap");for(g=0;g<f.length;g++)h=a(f[g]),i=h.attr("unique-id"),i==c.uniqueIdentifier&&(data=JSON.parse(d),"object"==typeof data&&(h.find(".itc_upload_progess_wrap").remove(),data.status>0?(h.find(".itc_upload_progress_txt").append('<span class="itc_upload_finish">完成</span>'),h.find(".itc_upload_cancel").remove(),h.find(".itc_upload_delfail").show().removeClass("itc_upload_delfail"),data.msg&&(h.data("ajaxMsg",data.msg),(b.downloadFileUrl||b.delFileUrl)&&h.attr("fileID",data.msg))):(h.find(".itc_upload_progress_txt").append('<span class="itc_upload_fail">'+data.msg+"</span>"),h.find(".itc_upload_cancel").hide(),h.find(".itc_upload_delfail").show())))}),n.assignBrowse(a("#"+k)),b.initFiles&&isArray(b.initFiles)&&e.createInitList(b.initFiles))},e.getFileIds=function(){var f,g,b=d.attr("id")+"_queue",c=[],e=a("#"+b).find(".itc_upload_wrap");for(f=0;f<e.length;f++)g=a(e[f]).attr("fileID"),g.indexOf("SWF")<0&&c.push(g);return c.join(",")},e.createInitList=function(b){var g,h,i,j,k,l,m,n,o,p,q,c=d.children(".upload-queue"),e=c.data("options"),f="";for(g=0;g<b.length;g++)h=b[g],i=e.itemTemplate,i=i.replace(new RegExp("<a.*?取消</a>"),""),k=h.fileName,e.openFileUrl?(l=e.openFileUrl.indexOf("?")>0?e.openFileUrl+"&":e.openFileUrl+"?",m=h.fileName.lastIndexOf("."),l+="id="+h.fileID+"&name=a"+h.fileName.substring(m),j="<a class='upload-viewdoc' id='"+h.fileID+"' ext='"+_itc_getextname(h.fileName)+"'>"+k+"</a>"):j=k,n=h.fileName,i=i.replace(new RegExp("\\${fileID}"),h.fileID),i=i.replace(new RegExp("\\${fileName}","g"),j),i=i.replace(new RegExp("\\${fileExt}"),_itc_getextname(n)),i=i.replace(new RegExp("\\${fileSize}"),_itc_getfilesize(h.fileSize)),i=i.replace(new RegExp("\\${creator}"),h.creator),i=i.replace(new RegExp("\\${reserved}"),h.reserved),o=UiCommon.isPreviewableImg(n)||UiCommon.isPreviewableFile(n)&&"RECEIVE_SUCCESS"===h.status,i=i.replace(new RegExp("\\${preview}"),o?"preview":""),f+=i;if(e.singleFile&&b.length>0&&c.prev("div").hide(),c.children(".itc_upload_wrap").remove(),c.append(f),e.delFileUrl)for(p=c.find(".itc_upload_delfail"),g=0;g<p.length;g++)q=a(p[g]),q.parents(".itc_upload_wrap").attr("init",!0),(!e.canUserDelete||e.canUserDelete(b[g]))&&(q.removeClass("itc_upload_delfail").show(),_itc_binddel(q));e.downloadFileUrl&&c.find(".itc_upload_down").each(function(){a(this).removeClass("itc_upload_down").show(),_itc_binddownload(this)})},"object"==typeof b)e.init();else{if("getVal"==b)return e.getFileIds();if("isUploadFinish"==b)return e.isUploadFinish();"setInitList"==b&&e.createInitList(c)}return d}})}(jQuery),$(document).ready(function(){top._imageViewer.config({basePath:"."}),$("body").on("click",".itc_upload_wrap.preview",function(a){var d,e,f,g,h,b=$(a.currentTarget),c=$(a.target);c.hasClass("itc_link")||(d=b.attr("fileid"),e=b.find(".itc_filename").text(),UiCommon.isPreviewableImg(e)?(f=b.parents(".upload-queue"),g=f.data("options"),g&&(h=g.downloadFileUrl+"&id="+d,top._imageViewer.viewImage({url:h,fileName:e}))):top._imageViewer.viewDoc({fileId:d,fileName:e}))})});